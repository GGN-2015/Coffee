# COFFEE
Rubbish Compiler

编译器生成的代码旨在通过 DOS-BOX 中汇编程序 MASM 的编译。万分抱歉我的代码实在是 “不堪卒读”，编写仓促，望海涵。如果本文档中内容有谬误，或者对其中内容有疑惑，欢迎垂询。（**在开口骂人之前，请务必联系我。**——GGN\_2015）

# 文件树结构

根目录下的所有文件夹列举如下。

| 文件夹   | 备注                                                     |
| -------- | -------------------------------------------------------- |
| compiled | 储存编译得到的 ASM 文件                                  |
| exts     | 储存使用了拓展库的示例程序（设计汇编仿真器时不需要考虑） |
| import   | 储存所有的库文件（import/ext 下储存所有拓展库文件）      |
| programs | 储存用于测试的源代码文件                                 |

根目录下的程序文件列举如下。

| 头文件          | 源代码文件        | 备注               |
| --------------- | ----------------- | ------------------ |
| CodeMgr.h       | CodeMgr.cpp       | 代码生成器         |
| ErrorReport.h   | ErrorReport.cpp   | 报错模块           |
| FuncGraph.h     | FuncGraph.cpp     | 函数依赖 DAG       |
| KeywordMap.h    | KeywordMap.cpp    | 关键字字典         |
| Parser.h        | Parser.cpp        | 词法分析器         |
| ProgramReader.h | ProgramReader.cpp | 文法分析，语义检查 |
| Utils.h         | Utils.cpp         | 工具类             |
| VarMgr.h        | VarMgr.cpp        | 变量管理器         |
| 无              | coffee.cpp        | 程序入口点         |

根目录下除了 .o 文件外的其他文件列举如下。

| 文件名         | 备注                                                         |
| -------------- | ------------------------------------------------------------ |
| README.md      | 此说明文件                                                   |
| compileAll.py  | 编译目录 programs 中的全部用于测试的源代码文件，并存放在目录 compiled 中 |
| readme.txt     | 语法简介（**内容尚不完整，有待完善**）                       |
| Makefile.win   | devcpp 自动生成的 Makefile 文件                              |
| compileAll.bat | 调用 compileAll.py                                           |
| COFFEE.exe     | 编译器程序本身                                               |
| LICENSE        | 开源协议（请无视，将来可能会改）                             |

# 为汇编仿真提供的说明

下文中提到的立即数有三种可能：非负十进制整数，以 H （或h）为结尾的十六进制整数（没有统一的大小写），负十进制整数。

## CodeMgr 能够直接生成的指令模式

以下为 CodeMgr 类能够直接产生的指令模式。但是由于语言可以支持内嵌汇编，所以可能会出现独立于下述模式之外的模式。

| 操作码 | 操作数               | 操作数      | 备注             |
| ------ | -------------------- | ----------- | ---------------- |
| ADD    | 寄存器               | 寄存器      |                  |
| AND    | 寄存器               | 寄存器      |                  |
| CALL   | 标识符               |             |                  |
| CMP    | 寄存器               | 立即数      |                  |
| IDIV   | BX                   |             |                  |
| IMUL   | BX                   |             |                  |
| INT    | 21H                  |             |                  |
| JE     | 标识符               |             |                  |
| JG     | 标识符               |             |                  |
| JGE    | 标识符               |             |                  |
| JL     | 标识符               |             |                  |
| JMP    | 标识符               |             |                  |
| JNE    | 标识符               |             |                  |
| JNZ    | 标识符               |             |                  |
| JZ     | 标识符               |             |                  |
| MOV    | [BP-立即数]          | 寄存器      | 为局部变量赋值   |
| MOV    | [SI]                 | 寄存器      |                  |
| MOV    | AH                   | 立即数      |                  |
| MOV    | AX                   | [BP+立即数] |                  |
| MOV    | AX                   | 段标识符    |                  |
| MOV    | 段寄存器             | AX          |                  |
| OR     | 寄存器               | 寄存器      |                  |
| POP    | 寄存器               |             |                  |
| PUSH   | 寄存器               |             |                  |
| PUSH   | WORD PTR [BP-立即数] |             | 局部变量进栈     |
| PUSH   | WORD PTR [BX]        |             | 指针指向元素进栈 |
| SUB    | 寄存器               | 寄存器      |                  |
| SUB    | 寄存器               | 立即数      |                  |

## CodeMgr 可能间接生成的指令模式

编译时可能会将距离较近的 PUSH 和 POP 指令改用 MOV 指令实现，因此可能会出现以下指令模式。

| 操作码 | 操作数 | 操作数               | 备注 |
| ------ | ------ | -------------------- | ---- |
| MOV    | 寄存器 | WORD PTR [BP-立即数] |      |
| MOV    | 寄存器 | WORD PTR [BX]        |      |

## 标准库中使用到的指令模式

省略了和 CodeMgr 能够直接生成的指令模式的公共部分。

| 操作码 | 操作数        | 操作数      | 备注                     |
| ------ | ------------- | ----------- | ------------------------ |
| INC    | 寄存器        |             |                          |
| JC     | 标识符        |             | 主要用于检测文件 IO 错误 |
| LEA    | DI            | 标识符      | 获取全局变量地址         |
| LEA    | DX            | [BP-立即数] | 获取局部变量地址         |
| MOV    | AH            | 立即数      |                          |
| MOV    | AL            | 立即数      |                          |
| MOV    | AX            | [SI]        |                          |
| MOV    | BYTE PTR [DI] | AL          |                          |
| MOV    | SI            | [BP-2]      |                          |

## 标准库以及 CodeMgr 中使用到的 INT 21H 参数

具体功能请参考 INT 21H 手册。

例如：[INT 21H 指令说明及使用方法-小哈龙的博客-CSDN博客_ int21h 指令表](https://blog.csdn.net/qq_22642239/article/details/79926484)

| MOV AH, 立即数 | 功能备注         |
| -------------- | ---------------- |
| 4ch            | 结束程序         |
| 02h            | 输出字符         |
| 01h            | 输入字符         |
| 3dh            | 打开文件         |
| 3ch            | 创建文件         |
| 41h            | 删除文件         |
| 3fh            | 从文件中读入字符 |
| 40h            | 向文件中输出字符 |

## 拓展库中使用到的指令模式

这部分可以不予考虑，测试时不会引用拓展库的代码。

